# Self-Destructing Secret Agency Message Service

A secure message service that stores encrypted messages which self-destruct after being read or after failed decryption attempts. Built with Spring Boot and NATS messaging.

## Architecture

```
┌─────────┐     ┌──────────────┐     ┌────────────┐     ┌────────────────┐     ┌──────┐
│ Creator │────▶│ NATS Client  │────▶│   NATS     │────▶│ Crypto Service │────▶│  DB  │
└─────────┘     └──────────────┘     │   Server   │     └────────────────┘     └──────┘
                                     │            │
┌───────────┐   ┌──────────────┐     │            │
│ Recipient │◀──│ NATS Client  │◀────│            │
└───────────┘   └──────────────┘     └────────────┘
```

### Flow

1. **Save Message (Creator)**:
   - Creator sends secret message via NATS
   - Service generates random AES key and password
   - Message is encrypted and stored (key and password are NOT stored - only password hash!)
   - ID, password and AES key returned to creator
   - Creator shares ID, password and key with recipient via secure second factor

2. **Receive Message (Recipient)**:
   - Recipient sends ID, password and AES key via NATS
   - Service verifies password and attempts decryption
   - Success: Message returned and deleted from database
   - Failure: Try counter incremented, message deleted after 3 failed attempts

## Requirements

- Java 21+
- Docker & Docker Compose
- Gradle 8.5+ (wrapper included)

### First-Time Setup

If the Gradle wrapper jar is missing, generate it:
```bash
# Option 1: Using system Gradle
gradle wrapper --gradle-version 8.5

# Option 2: Using SDKMAN
sdk install gradle 8.5
gradle wrapper
```

## Quick Start

### 1. Start the Services

```bash
# Start NATS server and Crypto Service
docker-compose up -d

# Wait for services to be healthy
docker-compose ps
```

### 2. Run the Tests

```bash
# Run integration tests (requires running NATS server)
./gradlew test
```

### 3. View Logs

```bash
# View all logs
docker-compose logs -f

# View only crypto service logs
docker-compose logs -f crypto-service
```

## Configuration

All configuration can be set via environment variables:

| Variable | Default | Description |
|----------|---------|-------------|
| `NATS_URL` | `nats://localhost:4222` | NATS server URL |
| `CRYPTO_KEY_LENGTH` | `256` | AES key length in bits (128, 192, 256) |
| `CRYPTO_MAX_TRIES` | `3` | Max decryption attempts before deletion |
| `CRYPTO_MAX_AGE_DAYS` | `2` | Auto-delete messages older than N days |
| `CRYPTO_CLEANUP_INTERVAL_MS` | `3600000` | Cleanup scheduler interval (1 hour) |
| `CRYPTO_PASSWORD_LENGTH` | `16` | Auto-generated password length |

### Example with Custom Configuration

```bash
CRYPTO_MAX_TRIES=5 CRYPTO_MAX_AGE_DAYS=7 docker-compose up -d
```

## Development

### Local Development (without Docker)

1. Start NATS server:
```bash
docker run -d --name nats -p 4222:4222 -p 8222:8222 nats:2.10-alpine
```

2. Run the application:
```bash
./gradlew bootRun
```

### Running Tests

```bash
# Unit tests only (no NATS required)
./gradlew test --tests "*ServiceTest"

# Integration tests (requires NATS)
./gradlew test --tests "*IntegrationTest"

# All tests with coverage
./gradlew test jacocoTestReport
```

### Building

```bash
# Build JAR
./gradlew build

# Build Docker image
docker build -t crypto-service .

# Build GraalVM native image (smaller footprint)
docker build -f Dockerfile.native -t crypto-service:native .
```

## API (NATS Subjects)

### `save.msg` - Save a Secret Message

**Request:**
```json
{
  "message": "The eagle has landed at midnight"
}
```

**Response:**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "password": "aB3$kL9@mN2#pQ7!",
  "aesKey": "SGVsbG8gV29ybGQhIFRoaXMgaXMgYSBzZWNyZXQ=",
  "success": true
}
```

Note: The password is auto-generated by the service and cannot be set by the creator.

### `receive.msg` - Receive a Secret Message

**Request:**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "password": "secretAgentPassword",
  "aesKey": "SGVsbG8gV29ybGQhIFRoaXMgaXMgYSBzZWNyZXQ="
}
```

**Success Response:**
```json
{
  "message": "The eagle has landed at midnight",
  "success": true,
  "deleted": true
}
```

**Failure Response (wrong key):**
```json
{
  "success": false,
  "errorMessage": "Invalid AES key. Decryption failed.",
  "remainingTries": 2,
  "deleted": false
}
```

## Project Structure

```
secret-message-service/
├── src/
│   ├── main/
│   │   ├── java/com/agency/crypto/
│   │   │   ├── config/          # Configuration classes
│   │   │   ├── controller/      # NATS message handlers
│   │   │   ├── dto/             # Request/Response DTOs
│   │   │   ├── entity/          # JPA entities
│   │   │   ├── exception/       # Custom exceptions
│   │   │   ├── repository/      # JPA repositories
│   │   │   └── service/         # Business logic
│   │   └── resources/
│   │       ├── application.yml  # Default config
│   │       └── application-docker.yml
│   └── test/
│       ├── java/com/agency/crypto/
│       │   ├── NatsClientIntegrationTest.java
│       │   ├── SecretMessageServiceTest.java
│       │   └── StandaloneNatsClient.java
│       └── resources/
├── docker/
│   └── nats/
│       └── nats-server.conf
├── docker-compose.yml           # Production setup
├── docker-compose.dev.yml       # Development setup
├── Dockerfile                   # Standard Docker build
├── Dockerfile.native            # GraalVM native build
├── build.gradle
└── README.md
```

## Security Features

- **AES-256-GCM encryption**: Military-grade authenticated encryption
- **No key storage**: AES keys are never stored in the database
- **Self-destruction**: Messages auto-delete after:
  - Successful retrieval
  - 3 failed decryption attempts (configurable)
  - 2 days (configurable cleanup scheduler)
- **Secure random generation**: Uses `SecureRandom` for keys and IVs

## Features

- Proper error handling throughout
- GraalVM native image support (`Dockerfile.native`)
- Scheduler for auto-deleting old messages
- Configurable max tries, max age, key length and password length via environment
- Auto-generated passwords with BCrypt hashing
- NKey authentication support for NATS (configurable via `NATS_NKEY_SEED`)
- TLS support for NATS connections (configurable via `NATS_TLS_ENABLED`)

## Monitoring

- **NATS Monitoring**: http://localhost:8222
- **Crypto Service Health**: http://localhost:8080/actuator/health

## Troubleshooting

### Services won't start
```bash
# Check logs
docker-compose logs

# Restart services
docker-compose restart
```

### Tests fail with connection errors
```bash
# Ensure NATS is running
docker-compose ps

# Check NATS health
curl http://localhost:8222/healthz
```

### Message decryption fails
- Verify the AES key is exactly as received (Base64 encoded)
- Check remaining tries in the response
- Ensure message hasn't been auto-deleted (older than 2 days)

## License

Copyright 2024 Secret Agency. All rights reserved.

---

*"This message will self-destruct in 5 seconds..."*
